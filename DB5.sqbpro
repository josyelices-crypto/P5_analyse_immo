<?xml version="1.0" encoding="UTF-8"?><sqlb_project><db path="DB5.db" readonly="0" foreign_keys="0" case_sensitive_like="0" temp_store="0" wal_autocheckpoint="1000" synchronous="2"/><attached/><window><main_tabs open="structure browser pragmas query" current="3"/></window><tab_structure><column_width id="0" width="300"/><column_width id="1" width="0"/><column_width id="2" width="100"/><column_width id="3" width="5708"/><column_width id="4" width="0"/><expanded_item id="0" parent="1"/><expanded_item id="1" parent="1"/><expanded_item id="2" parent="1"/><expanded_item id="3" parent="1"/></tab_structure><tab_browse><table title="BIEN" custom_title="0" dock_id="1" table="4,4:mainBIEN"/><dock_state state="000000ff00000000fd00000001000000020000038a000002d2fc0100000001fb000000160064006f0063006b00420072006f007700730065003101000000000000038a0000013800ffffff0000038a0000000000000004000000040000000800000008fc00000000"/><default_encoding codec=""/><browse_table_settings><table schema="main" name="BIEN" show_row_id="0" encoding="" plot_x_axis="" unlock_view_pk="_rowid_" freeze_columns="0"><sort/><column_widths><column index="1" value="52"/><column index="2" value="93"/><column index="3" value="99"/><column index="4" value="72"/><column index="5" value="122"/><column index="6" value="163"/><column index="7" value="101"/></column_widths><filter_values/><conditional_formats/><row_id_formats/><display_formats/><hidden_columns/><plot_y_axes/><global_filter/></table><table schema="main" name="COMMUNE" show_row_id="0" encoding="" plot_x_axis="" unlock_view_pk="_rowid_" freeze_columns="0"><sort/><column_widths><column index="2" value="97"/><column index="3" value="120"/></column_widths><filter_values/><conditional_formats/><row_id_formats/><display_formats/><hidden_columns/><plot_y_axes/><global_filter/></table><table schema="main" name="DEPARTEMENT" show_row_id="0" encoding="" plot_x_axis="" unlock_view_pk="_rowid_" freeze_columns="0"><sort/><column_widths><column index="1" value="119"/><column index="2" value="191"/><column index="3" value="83"/></column_widths><filter_values/><conditional_formats/><row_id_formats/><display_formats/><hidden_columns/><plot_y_axes/><global_filter/></table><table schema="main" name="REGION" show_row_id="0" encoding="" plot_x_axis="" unlock_view_pk="_rowid_" freeze_columns="0"><sort/><column_widths><column index="1" value="82"/><column index="2" value="215"/></column_widths><filter_values/><conditional_formats/><row_id_formats/><display_formats/><hidden_columns/><plot_y_axes/><global_filter/></table></browse_table_settings></tab_browse><tab_sql><sql name="REGION">
--- ÉTAPE 1 : CRÉATION DE LA TABLE REGION (AVEC CLÉ PRIMAIRE)

PRAGMA foreign_keys = OFF;
DROP TABLE IF EXISTS REGION;
CREATE TABLE REGION (
    Code_Region VARCHAR(30) NOT NULL PRIMARY KEY, 
    Nom_Region VARCHAR(30) NOT NULL
);
DELETE FROM REGION;

INSERT INTO REGION (Code_Region, Nom_Region)
SELECT
    REPLACE(REPLACE(REPLACE(t1.reg_code, ' ', ''), CHAR(160), ''), X'0D', '') AS Code_Region,
    MAX(t1.reg_nom) AS Nom_Region
FROM 
    &quot;referentiel_brut&quot; t1
WHERE
    t1.reg_code IS NOT NULL
GROUP BY 
    Code_Region;
    
SELECT COUNT(*) AS '1. Régions insérées' FROM REGION;

PRAGMA foreign_keys = ON;</sql><sql name="DEPARTEMENT">
--- ÉTAPE 2 : CRÉATION DE LA TABLE DEPARTEMENT (AVEC CLÉ PRIMAIRE)

DROP TABLE IF EXISTS DEPARTEMENT;
CREATE TABLE DEPARTEMENT (
    Code_Departement VARCHAR(30) NOT NULL PRIMARY KEY,
    Nom_Departement VARCHAR(30),
    Code_Region VARCHAR(30) NOT NULL,
    FOREIGN KEY (Code_Region) REFERENCES REGION(Code_Region)
);
DELETE FROM DEPARTEMENT;

INSERT INTO DEPARTEMENT (Code_Departement, Nom_Departement, Code_Region)
SELECT 
    CASE 
        WHEN REPLACE(REPLACE(REPLACE(t1.CODDEP, ' ', ''), CHAR(160), ''), X'0D', '') GLOB '[0-9]*' AND LENGTH(REPLACE(REPLACE(REPLACE(t1.CODDEP, ' ', ''), CHAR(160), ''), X'0D', '')) &lt;= 2
        THEN printf('%02d', CAST(REPLACE(REPLACE(REPLACE(t1.CODDEP, ' ', ''), CHAR(160), ''), X'0D', '') AS INTEGER))             
        ELSE REPLACE(REPLACE(REPLACE(t1.CODDEP, ' ', ''), CHAR(160), ''), X'0D', '')                                             
    END AS Code_Departement,
    
    MAX(t1.COM) AS Nom_Departement,
    REPLACE(REPLACE(REPLACE(t1.CODREG, ' ', ''), CHAR(160), ''), X'0D', '') AS Code_Region
    
FROM 
    &quot;commune_brut&quot; t1
WHERE t1.CODDEP IS NOT NULL AND t1.CODDEP &lt;&gt; ''
GROUP BY Code_Departement; 

SELECT COUNT(*) AS '2. Départements insérés (Étape 1)' FROM DEPARTEMENT;

UPDATE DEPARTEMENT 
SET Nom_Departement = (
    SELECT 
        MAX(t2.dep_nom)
    FROM &quot;referentiel_brut&quot; t2 
    WHERE 
        DEPARTEMENT.Code_Departement = TRIM(REPLACE(t2.dep_code, ' ', ''))
);

SELECT COUNT(*) AS '2. Départements finaux (après UPDATE)' FROM DEPARTEMENT;</sql><sql name="COMMUNE">
-- =======================================================================
-- III. TABLE COMMUNE (FK vers DEPARTEMENT)
-- =======================================================================
DROP TABLE IF EXISTS COMMUNE;
CREATE TABLE COMMUNE (
    Code_Commune VARCHAR(30) NOT NULL PRIMARY KEY,
    Nom_Commune VARCHAR(30) NOT NULL,
    Code_Departement VARCHAR(30) NOT NULL,
    FOREIGN KEY (Code_Departement) REFERENCES DEPARTEMENT(Code_Departement)
);
DELETE FROM COMMUNE;

INSERT INTO COMMUNE (Code_Commune, Nom_Commune, Code_Departement)
SELECT
    -- 1. Code_Commune (PK) : Clé INSEE Complète (Dep + Com)
    (CASE 
        WHEN REPLACE(REPLACE(REPLACE(t2.dep_code, ' ', ''), CHAR(160), ''), X'0D', '') GLOB '[0-9]*' AND LENGTH(REPLACE(REPLACE(REPLACE(t2.dep_code, ' ', ''), CHAR(160), ''), X'0D', '')) &lt;= 2
        THEN printf('%02d', CAST(REPLACE(REPLACE(REPLACE(t2.dep_code, ' ', ''), CHAR(160), ''), X'0D', '') AS INTEGER))             
        ELSE REPLACE(REPLACE(REPLACE(t2.dep_code, ' ', ''), CHAR(160), ''), X'0D', '')                                             
    END) || 
    (CASE 
        WHEN REPLACE(REPLACE(REPLACE(t2.com_code, ' ', ''), CHAR(160), ''), X'0D', '') GLOB '[0-9]*' AND LENGTH(REPLACE(REPLACE(REPLACE(t2.com_code, ' ', ''), CHAR(160), ''), X'0D', '')) &lt; 3
        THEN printf('%03d', CAST(REPLACE(REPLACE(REPLACE(t2.com_code, ' ', ''), CHAR(160), ''), X'0D', '') AS INTEGER))             
        ELSE REPLACE(REPLACE(REPLACE(t2.com_code, ' ', ''), CHAR(160), ''), X'0D', '')                                             
    END) AS Code_Commune, 
    
    -- 2. Nom_Commune
    MAX(t2.com_nom_maj) AS Nom_Commune,   

    -- 3. Code_Departement (FK)
    CASE 
        WHEN REPLACE(REPLACE(REPLACE(t2.dep_code, ' ', ''), CHAR(160), ''), X'0D', '') GLOB '[0-9]*' AND LENGTH(REPLACE(REPLACE(REPLACE(t2.dep_code, ' ', ''), CHAR(160), ''), X'0D', '')) &lt;= 2
        THEN printf('%02d', CAST(REPLACE(REPLACE(REPLACE(t2.dep_code, ' ', ''), CHAR(160), ''), X'0D', '') AS INTEGER))             
        ELSE REPLACE(REPLACE(REPLACE(t2.dep_code, ' ', ''), CHAR(160), ''), X'0D', '')                                             
    END AS Code_Departement
    
FROM &quot;referentiel_brut&quot; t2 
WHERE t2.com_code IS NOT NULL
GROUP BY Code_Commune;
SELECT COUNT(*) AS '3. Communes insérées' FROM COMMUNE;
</sql><sql name="POPULATION">
-- =======================================================================
-- IV. TABLE POPULATION (FK vers COMMUNE)
-- =======================================================================
DROP TABLE IF EXISTS POPULATION;
CREATE TABLE POPULATION (
    Code_Commune VARCHAR(30) NOT NULL PRIMARY KEY,
    Population_Totale INTEGER,
    FOREIGN KEY (Code_Commune) REFERENCES COMMUNE(Code_Commune)
);
DELETE FROM POPULATION;

INSERT INTO POPULATION (Code_Commune, Population_Totale)
SELECT
    -- 1. Code_Commune (PK/FK) : Clé INSEE Complète (Dep + Com)
    (CASE 
        WHEN REPLACE(REPLACE(REPLACE(t1.CODDEP, ' ', ''), CHAR(160), ''), X'0D', '') GLOB '[0-9]*' AND LENGTH(REPLACE(REPLACE(REPLACE(t1.CODDEP, ' ', ''), CHAR(160), ''), X'0D', '')) &lt;= 2
        THEN printf('%02d', CAST(REPLACE(REPLACE(REPLACE(t1.CODDEP, ' ', ''), CHAR(160), ''), X'0D', '') AS INTEGER))             
        ELSE REPLACE(REPLACE(REPLACE(t1.CODDEP, ' ', ''), CHAR(160), ''), X'0D', '')                                             
    END) || 
    (CASE 
        WHEN REPLACE(REPLACE(REPLACE(t1.CODCOM, ' ', ''), CHAR(160), ''), X'0D', '') GLOB '[0-9]*' AND LENGTH(REPLACE(REPLACE(REPLACE(t1.CODCOM, ' ', ''), CHAR(160), ''), X'0D', '')) &lt; 3
        THEN printf('%03d', CAST(REPLACE(REPLACE(REPLACE(t1.CODCOM, ' ', ''), CHAR(160), ''), X'0D', '') AS INTEGER))             
        ELSE REPLACE(REPLACE(REPLACE(t1.CODCOM, ' ', ''), CHAR(160), ''), X'0D</sql><sql name="SQL 9">-- 1. Nombre total d’appartements vendus au 1er semestre 2020
SELECT COUNT(*) AS Total_Appartements_S1
FROM Bien
WHERE Type_Local LIKE 'Appartement%' 
AND Date_Mutation BETWEEN '2020-01-01' AND '2020-06-30';

</sql><sql name="SQL 10">-- 2. Le nombre de ventes d’appartement par région pour le 1er semestre 2020
SELECT r.Nom_Region, COUNT(b.ID_Bien) AS Nombre_Ventes
FROM Bien b
JOIN COMMUNE c ON printf('%05s', TRIM(b.Code_Commune)) = printf('%05s', TRIM(c.Code_Commune))
JOIN DEPARTEMENT d ON c.Code_Departement = d.Code_Departement
JOIN REGION r ON d.Code_Region = r.Code_Region
WHERE b.Type_Local LIKE 'Appartement%' 
AND b.Date_Mutation BETWEEN '2020-01-01' AND '2020-06-30'
GROUP BY r.Nom_Region;
</sql><sql name="SQL 11">
-- 3. Proportion des ventes d’appartements par le nombre de pièces
SELECT Nombre_pieces_principales, 
       COUNT(*) AS Nb_Ventes,
       ROUND(COUNT(*) * 100.0 / (SELECT COUNT(*) FROM Bien WHERE Type_Local LIKE 'Appartement%'), 2) || '%' AS Proportion
FROM Bien
WHERE Type_Local LIKE 'Appartement%'
GROUP BY Nombre_pieces_principales;
</sql><sql name="SQL 12"></sql><sql name="SQL 13"></sql><sql name="SQL 14"></sql><sql name="SQL 15"></sql><sql name="SQL 16"></sql><sql name="SQL 17"></sql><sql name="SQL 18"></sql><sql name="SQL 19"></sql><sql name="SQL 20"></sql><sql name="SQL 21"></sql><sql name="SQL 22"></sql><sql name="SQL 23"></sql><current_tab id="18"/></tab_sql></sqlb_project>
